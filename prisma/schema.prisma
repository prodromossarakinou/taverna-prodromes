generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model MenuItem {
  id         String  @id
  name       String
  category   String
  price      Float?
  extraNotes String?
  active     Boolean @default(true)
}

model Order {
  id          String      @id @default(cuid())
  tableNumber String
  waiterName  String
  timestamp   DateTime    @default(now())
  status      String      @default("pending")
  extraNotes  String?
  isExtra     Boolean     @default(false)
  parentId    String?
  items       OrderItem[]
}

model OrderItem {
  id         String  @id @default(cuid())
  name       String
  quantity   Int
  category   String
  itemStatus String  @default("pending")
  extraNotes String?
  orderId    String
  order      Order   @relation(fields: [orderId], references: [id])
  units      OrderItemUnit[]
}

model OrderItemUnit {
  id          String    @id @default(cuid())
  orderItemId String
  status      String    @default("pending")
  unitIndex   Int
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id])

  @@index([orderItemId])
}

// New billing models
model Bill {
  id             String      @id @default(cuid())
  tableNumber    String
  createdAt      DateTime    @default(now())
  closedAt       DateTime?
  status         String      @default("open") // open | closed | cancelled
  waiterName     String?

  // References for audit (orders included in this bill)
  baseOrderIds   String[]
  extraOrderIds  String[]

  // Financials (snapshots at the time of creation)
  subtotalBase    Float      @default(0)
  subtotalExtras  Float      @default(0)
  discountType    String?
  discountValue   Float?
  grandTotal      Float      @default(0)

  items          BillItem[]
}

model BillItem {
  id          String  @id @default(cuid())
  billId      String
  bill        Bill    @relation(fields: [billId], references: [id])

  menuItemId  String?
  name        String
  category    String
  quantity    Int
  unitPrice   Float?
  lineTotal   Float

  orderId     String?
  isExtra     Boolean @default(false)

  @@index([billId])
}
