import React, { useState, useMemo } from 'react';
import { X } from 'lucide-react';
import { Button } from './ui/button';
import { useOrders, OrderCategory } from '../contexts/OrderContext';
import { ScrollArea } from './ui/scroll-area';

const CATEGORY_LABELS: Record<OrderCategory, string> = {
  'cold-salads': 'ΚΡΥΑ ΚΟΥΖΙΝΑ',
  'hot-salads': 'ΖΕΣΤΕΣ ΣΑΛΑΤΕΣ',
  'grill': 'ΨΗΣΤΑΡΙΑ',
  'cooked': 'ΜΑΓΕΙΡΕΥΤΟ',
  'drinks': 'ΠΟΤΑ',
};

export function KitchenDisplay() {
  const { orders, completeOrder, deleteOrder, updateItemStatus } = useOrders();
  const [selectedFilter, setSelectedFilter] = useState<OrderCategory | 'all'>('all');

  const pendingOrders = useMemo(() => {
    return orders
      .filter(order => order.status === 'pending')
      .sort((a, b) => a.timestamp - b.timestamp);
  }, [orders]);

  const filteredOrders = useMemo(() => {
    if (selectedFilter === 'all') {
      return pendingOrders.slice(0, 10);
    }
    return pendingOrders
      .filter(order => 
        order.items.some(item => item.category === selectedFilter)
      )
      .slice(0, 10);
  }, [pendingOrders, selectedFilter]);

  const handleItemClick = (orderId: string, itemId: string, currentStatus?: string) => {
    const nextStatus = 
      currentStatus === 'delivered' ? 'pending' :
      currentStatus === 'ready' ? 'delivered' : 'ready';
    updateItemStatus(orderId, itemId, nextStatus);
  };

  const groupItemsByCategory = (items: any[]) => {
    const grouped: Record<string, any[]> = {};
    items.forEach(item => {
      if (!grouped[item.category]) {
        grouped[item.category] = [];
      }
      grouped[item.category].push(item);
    });
    return grouped;
  };

  return (
    <div className="min-h-screen bg-gray-100">
      {/* Header */}
      <div className="bg-slate-800 text-white p-4 shadow-lg">
        <div className="max-w-full mx-auto">
          <h1 className="text-2xl font-bold mb-3">ΠΑΣΟ - {pendingOrders.length} Παραγγελίες</h1>
          
          {/* Filter Tabs */}
          <ScrollArea className="w-full">
            <div className="flex gap-2">
              <Button
                variant={selectedFilter === 'all' ? 'default' : 'outline'}
                onClick={() => setSelectedFilter('all')}
                size="sm"
                className="whitespace-nowrap"
              >
                ΟΛA ({pendingOrders.length})
              </Button>
              {(Object.keys(CATEGORY_LABELS) as OrderCategory[]).map((cat) => {
                const count = pendingOrders.filter(order =>
                  order.items.some(item => item.category === cat)
                ).length;
                return (
                  <Button
                    key={cat}
                    variant={selectedFilter === cat ? 'default' : 'outline'}
                    onClick={() => setSelectedFilter(cat)}
                    size="sm"
                    className="whitespace-nowrap"
                  >
                    {CATEGORY_LABELS[cat]} ({count})
                  </Button>
                );
              })}
            </div>
          </ScrollArea>
        </div>
      </div>

      {/* Orders Grid */}
      <div className="p-4">
        {filteredOrders.length === 0 ? (
          <div className="text-center py-20">
            <p className="text-xl text-gray-600">Δεν υπάρχουν εκκρεμείς παραγγελίες</p>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
            {filteredOrders.map((order, index) => {
              const displayedItems = selectedFilter === 'all' 
                ? order.items 
                : order.items.filter(item => item.category === selectedFilter);
              
              const groupedItems = groupItemsByCategory(displayedItems);

              return (
                <div
                  key={order.id}
                  className="bg-white rounded-lg shadow-md border-2 border-gray-300"
                >
                  {/* Order Header */}
                  <div className="bg-gray-100 p-3 flex items-center justify-between border-b-2 border-gray-300">
                    <div className="flex items-center gap-2">
                      <span className="text-xs font-bold px-2 py-1 rounded bg-blue-600 text-white">
                        #{index + 1}
                      </span>
                      <h3 className="text-xl font-bold text-gray-900">
                        Τραπέζι {order.tableNumber}
                      </h3>
                    </div>
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => deleteOrder(order.id)}
                      className="h-7 w-7 p-0 text-red-600 hover:text-red-700 hover:bg-red-50"
                    >
                      <X className="size-4" />
                    </Button>
                  </div>

                  {/* Order Items grouped by category */}
                  <div className="p-3 space-y-3">
                    {Object.entries(groupedItems).map(([category, items]) => (
                      <div key={category}>
                        <div className="text-xs font-bold text-gray-600 mb-1 uppercase">
                          {CATEGORY_LABELS[category as OrderCategory]}
                        </div>
                        <div className="space-y-1">
                          {items.map((item) => {
                            const status = item.itemStatus || 'pending';
                            const bgColor = 
                              status === 'delivered' ? 'bg-green-500 text-white' :
                              status === 'ready' ? 'bg-blue-500 text-white' : 
                              'bg-white';
                            
                            return (
                              <button
                                key={item.id}
                                onClick={() => handleItemClick(order.id, item.id, status)}
                                className={`w-full text-left p-2 rounded border-2 transition-all ${bgColor} ${
                                  status === 'pending' ? 'border-gray-300 hover:border-gray-400' : 'border-transparent'
                                }`}
                              >
                                <div className="flex items-center justify-between">
                                  <span className="text-sm font-medium">{item.name}</span>
                                  <span className="text-lg font-bold">×{item.quantity}</span>
                                </div>
                                {item.notes && (
                                  <div className="text-xs mt-1 opacity-80">{item.notes}</div>
                                )}
                              </button>
                            );
                          })}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
}
