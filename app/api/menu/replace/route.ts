import { NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { randomUUID } from 'crypto';

// Σταθερή αντικατάσταση μενού: Διαγράφει ΟΛΑ τα MenuItem και εισάγει τα νέα.
// Χρησιμοποιεί extraNotes για τις υποκατηγορίες (όπου υπάρχουν).

type NewItem = {
  name: string;
  category: string;
  price: number | null;
  extraNotes?: string | null;
  active?: boolean;
};

function buildNewMenu(): NewItem[] {
  const items: NewItem[] = [];

  const add = (
    name: string,
    category: string,
    price: number | null,
    extraNotes: string | null = null,
    active = true,
  ) => items.push({ name, category, price, extraNotes, active });

  // Ορεκτικά
  add('Καυτερή Πιπεριά', 'Ορεκτικά', 2.0);
  add('Ντολμαδάκια', 'Ορεκτικά', 5.0);
  add('Πατάτες τηγανητές', 'Ορεκτικά', 4.0);
  add('Σκουμπρί Καπνιστό', 'Ορεκτικά', 6.0);

  // Τυριά
  add('Φέτα', 'Τυριά', 4.0);

  // Αλοιφές
  add('Ταραμάς', 'Αλοιφές', 4.0);
  add('Τζατζίκι', 'Αλοιφές', 4.0);

  // Σαλάτες
  add('Μαρούλι & Ρόκα', 'Σαλάτες', 4.0);
  add('Πατατοσαλάτα', 'Σαλάτες', 4.0);
  add('Πικάντικη', 'Σαλάτες', 4.0);

  // Μαγειρευτά
  add('Ζυγούρι στη γάστρα', 'Μαγειρευτά', 10.0);
  add('Κοκκινιστό Μοσχαράκι', 'Μαγειρευτά', 9.0);

  // Μερίδες
  add('Κότσι', 'Μερίδες', 12.0, 'Χοιρινό');

  // Νηστίσιμα
  add('Αντζούγιες', 'Νηστίσιμα', 5.0);
  add('Καλαμαράκια Τηγανητά', 'Νηστίσιμα', 9.0);
  add('Μυδοπίλαφο', 'Νηστίσιμα', 9.0);
  add('Σουπιές κρασάτες', 'Νηστίσιμα', 11.0);
  add('Φασουλονταβάς', 'Νηστίσιμα', 6.0);
  add('Χταπόδι Ξυδάτο', 'Νηστίσιμα', 9.0);

  // Ψητά/Της ώρας (υποκατηγορία: Μερίδες)
  add('Λουκάνικο Χωριάτικο', 'Ψητά/Της ώρας', 9.0, 'Μερίδες');

  // Σούβλες
  add('Κοντοσούβλι', 'Σούβλες', 11.0, 'Κοτόπουλο');
  add('Κοντοσούβλι', 'Σούβλες', 11.0, 'Χοιρινό');
  add('Ελασσονίτικο', 'Σούβλες', 11.0, 'Μερίδες');

  // Ποτά/Αναψυκτικά
  // Αναψυκτικά
  add('Βίκος Γκαζόζα 250ml', 'Ποτά/Αναψυκτικά', 2.5, 'Αναψυκτικά');
  add('Βίκος Κόλα 250ml', 'Ποτά/Αναψυκτικά', 2.5, 'Αναψυκτικά');
  add('Βίκος Λεμονάδα 250ml', 'Ποτά/Αναψυκτικά', 2.5, 'Αναψυκτικά');
  add('Βίκος Πορτοκαλάδα 250ml', 'Ποτά/Αναψυκτικά', 2.5, 'Αναψυκτικά');
  add('Βίκος Σόδα 250ml', 'Ποτά/Αναψυκτικά', 2.5, 'Αναψυκτικά');

  // Νερό
  add('Νερό - μικρό 500ml Εμφιαλωμένο', 'Ποτά/Αναψυκτικά', 0.5, 'Νερό');
  add('Νερό - μεγάλο 1.5lt Εμφιαλωμένο', 'Ποτά/Αναψυκτικά', 1.5, 'Νερό');

  // Ρετσίνα
  add('Βασιλική 500ml', 'Ποτά/Αναψυκτικά', 5.5, 'Ρετσίνα');
  add('Μαλαματίνα 500ml', 'Ποτά/Αναψυκτικά', 4.0, 'Ρετσίνα');

  // Κρασί
  add('Κρασί Λευκό 500ml', 'Ποτά/Αναψυκτικά', 4.0, 'Κρασί');
  add('Κρασί Κόκκινο 500ml', 'Ποτά/Αναψυκτικά', 4.0, 'Κρασί');
  add('Κρασί λευκό 1lt', 'Ποτά/Αναψυκτικά', 7.0, 'Κρασί');
  add('Κρασί κοκκινο 1lt', 'Ποτά/Αναψυκτικά', 7.0, 'Κρασί');

  // Τσίπουρο
  add('Αποστολάκη - Εμφιαλωμένο 200ml', 'Ποτά/Αναψυκτικά', 8.0, 'Τσίπουρο');
  add('Ηδωνικό - Εμφιαλωμένο 200ml - Χωρίς Γλυκάνισο', 'Ποτά/Αναψυκτικά', 10.0, 'Τσίπουρο');
  add('Χύμα 100ml - Χωρίς Γλυκάνισο', 'Ποτά/Αναψυκτικά', 3.5, 'Τσίπουρο');
  add('Χύμα 200ml - Χωρίς Γλυκάνισο', 'Ποτά/Αναψυκτικά', 7.0, 'Τσίπουρο');
  add('Χύμα 100ml - Με Γλυκάνισο', 'Ποτά/Αναψυκτικά', 3.5, 'Τσίπουρο');
  add('Χύμα 200ml - Με Γλυκάνισο', 'Ποτά/Αναψυκτικά', 7.0, 'Τσίπουρο');

  // Ούζο
  add('Ούζο 12 - Εμφιαλωμένο 200ml', 'Ποτά/Αναψυκτικά', 8.0, 'Ούζο');
  add('Πλωμάρι - Εμφιαλωμένο 200ml', 'Ποτά/Αναψυκτικά', 8.0, 'Ούζο');

  // Μπύρες (δεν δόθηκε τιμή -> null)
  add('ΑΛΦΑ 500ml', 'Ποτά/Αναψυκτικά', null, 'Μπύρες');

  return items;
}

export async function POST() {
  try {
    // 1) Διαγραφή όλων
    const del = await prisma.menuItem.deleteMany({});

    // 2) Εισαγωγή νέων
    const items = buildNewMenu();
    const data = items.map((it) => ({
      id: randomUUID(),
      name: it.name,
      category: it.category,
      price: it.price === null ? null : Number(it.price),
      extraNotes: it.extraNotes ?? null,
      active: it.active ?? true,
    }));

    // createMany για αποδοτικότητα
    const created = await prisma.menuItem.createMany({ data });

    return NextResponse.json({
      deleted: del.count,
      inserted: created.count,
      categories: Array.from(new Set(items.map((i) => i.category))),
    });
  } catch (error) {
    console.error('Error replacing menu:', error);
    return NextResponse.json({ error: 'Failed to replace menu' }, { status: 500 });
  }
}
